// Import necessary Angular modules and Material components
import { Component, OnInit } from '@angular/core';
import { MatTableModule } from '@angular/material/table';
import { HttpClient } from '@angular/common/http';

interface TableEntry {
  projectKey: string;
  projectName: string;
  applicationName: string;
  component: string;
  section: string;
  componentCount: number;
  importCount: number;
}

@Component({
  selector: 'app-json-table',
  standalone: true,
  imports: [MatTableModule],
  template: `
    <table mat-table [dataSource]="data" class="mat-elevation-z8">
      <ng-container matColumnDef="projectKey">
        <th mat-header-cell *matHeaderCellDef> Project Key </th>
        <td mat-cell *matCellDef="let element"> {{element.projectKey}} </td>
      </ng-container>
      
      <ng-container matColumnDef="projectName">
        <th mat-header-cell *matHeaderCellDef> Project Name </th>
        <td mat-cell *matCellDef="let element"> {{element.projectName}} </td>
      </ng-container>
      
      <ng-container matColumnDef="applicationName">
        <th mat-header-cell *matHeaderCellDef> Application Name </th>
        <td mat-cell *matCellDef="let element"> {{element.applicationName}} </td>
      </ng-container>

      <ng-container matColumnDef="component">
        <th mat-header-cell *matHeaderCellDef> Component </th>
        <td mat-cell *matCellDef="let element"> {{element.component}} </td>
      </ng-container>

      <ng-container matColumnDef="section">
        <th mat-header-cell *matHeaderCellDef> Section </th>
        <td mat-cell *matCellDef="let element"> {{element.section}} </td>
      </ng-container>

      <ng-container matColumnDef="componentCount">
        <th mat-header-cell *matHeaderCellDef> Component Count </th>
        <td mat-cell *matCellDef="let element"> {{element.componentCount}} </td>
      </ng-container>

      <ng-container matColumnDef="importCount">
        <th mat-header-cell *matHeaderCellDef> Import Count </th>
        <td mat-cell *matCellDef="let element"> {{element.importCount}} </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>
  `,
  styles: [
    'table { width: 100%; margin-top: 20px; }',
    'th, td { padding: 8px; text-align: left; }'
  ]
})
export class JsonTableComponent implements OnInit {
  displayedColumns: string[] = ['projectKey', 'projectName', 'applicationName', 'component', 'section', 'componentCount', 'importCount'];
  data: TableEntry[] = [];

  constructor(private http: HttpClient) {}

  ngOnInit() {
    this.http.get<any>('assets/data/data.json').subscribe(json => {
      this.data = this.transformData(json);
    });
  }

  transformData(json: any): TableEntry[] {
    const result: TableEntry[] = [];
    for (const key in json) {
      if (json.hasOwnProperty(key)) {
        const spec = json[key].spec;
        const components = json[key].components;
        for (const component in components) {
          if (components.hasOwnProperty(component)) {
            for (const section in components[component]) {
              if (components[component].hasOwnProperty(section)) {
                const { componentCount, importCount } = components[component][section];
                result.push({
                  projectKey: spec.projectKey,
                  projectName: spec.projectName,
                  applicationName: spec.applicationName,
                  component,
                  section,
                  componentCount,
                  importCount
                });
              }
            }
          }
        }
      }
    }
    return result;
  }
}
